<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° ê¸€ë¡œë²Œ í™˜ìœ¨ ë° ê¸ˆë¦¬ ì •ë³´</title>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #343a40;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 700;
        }
        .container {
            display: flex;
            gap: 25px;
            max-width: 1500px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            flex-grow: 1;
        }
        .left-panel, .right-panel {
            padding: 15px;
            border-radius: 10px;
            background-color: #fefefe;
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
        }
        .left-panel {
            flex: 2; /* ì™¼ìª½ íŒ¨ë„ì´ ì˜¤ë¥¸ìª½ë³´ë‹¤ ì•½ê°„ ë„“ê²Œ */
            min-width: 450px;
        }
        .right-panel {
            flex: 3; /* ì˜¤ë¥¸ìª½ íŒ¨ë„ì´ ë” ë„“ê²Œ */
        }

        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }
        .top-controls label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        .top-controls select, .top-controls input[type="text"], .top-controls button {
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .top-controls input[type="text"] {
            flex-grow: 1;
        }
        .top-controls button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .top-controls button:hover {
            background-color: #218838;
        }
        .top-controls select:focus, .top-controls input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Table Styling */
        #resultTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            font-size: 0.9em;
        }
        #resultTable th, #resultTable td {
            border: 1px solid #e9ecef;
            padding: 12px 15px;
            text-align: left;
        }
        #resultTable th {
            background-color: #f2f2f2;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #resultTable tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        #resultTable tbody tr:hover {
            background-color: #e6f7ff;
            cursor: pointer;
        }
        .selected-row {
            background-color: #cceeff !important; /* ì„ íƒëœ í–‰ ê°•ì¡° */
            font-weight: bold;
            color: #0056b3;
        }
        .table-container {
            flex-grow: 1;
            overflow-y: auto; /* í…Œì´ë¸”ì´ ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ë°” ìƒì„± */
            max-height: 400px; /* ì ì ˆí•œ ìµœëŒ€ ë†’ì´ ì„¤ì • */
        }

        .detail-header {
            font-size: 1.6em;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 10px;
        }
        .detail-current-value {
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 15px;
        }
        .change-info {
            background-color: #e9f5ff;
            border: 1px solid #b3d9ff;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            white-space: pre-wrap;
            font-size: 0.9em;
            color: #333;
        }
        .change-info strong {
            color: #0056b3;
        }

        .graph-tabs {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        .tab-buttons button {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-bottom: none;
            background-color: #e9ecef;
            cursor: pointer;
            font-size: 1em;
            border-radius: 6px 6px 0 0;
            transition: background-color 0.2s, color 0.2s;
            color: #495057;
        }
        .tab-buttons button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .tab-buttons button:not(.active):hover {
            background-color: #cfd8dc;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            background-color: #fff;
            flex-grow: 1;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .graph-canvas {
            width: 100% !important;
            height: 350px !important; /* ê·¸ë˜í”„ ë†’ì´ ê³ ì • */
        }

        .status-bar {
            margin-top: 20px;
            padding: 12px 18px;
            background-color: #e2e3e5;
            border-radius: 8px;
            color: #495057;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <h1>ğŸ’° ê¸€ë¡œë²Œ í™˜ìœ¨ ë° ê¸ˆë¦¬ ì •ë³´</h1>

    <div class="container">
        <div class="left-panel">
            <div class="top-controls">
                <label for="searchType">ê²€ìƒ‰ ìœ í˜•:</label>
                <select id="searchType">
                    <option value="exchange">í™˜ìœ¨</option>
                    <option value="interest">ê¸ˆë¦¬</option>
                </select>
                <label for="searchQuery">ê²€ìƒ‰ì–´:</label>
                <input type="text" id="searchQuery" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="searchBtn">ê²€ìƒ‰</button>
                <button id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>í•­ëª©</th>
                            <th>ê°’</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="right-panel">
            <h2 id="detailTitle" class="detail-header">ì„ íƒëœ í•­ëª©: -</h2>
            <p id="detailCurrentValue" class="detail-current-value">í˜„ì¬ ê°’: -</p>

            <div id="changeInfo" class="change-info">
                <strong>ê³¼ê±° ë³€í™”ëŸ‰:</strong><br>
                <!-- ë³€í™”ëŸ‰ ì •ë³´ëŠ” JavaScriptë¡œ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                í•­ëª©ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="graph-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="fxGraph">í™˜ìœ¨ ì¶”ì´</button>
                    <button class="tab-btn" data-tab="irGraph">ê¸ˆë¦¬ ì¶”ì´</button>
                </div>

                <div id="fxGraph" class="tab-content active">
                    <canvas id="fxChart" class="graph-canvas"></canvas>
                </div>
                <div id="irGraph" class="tab-content">
                    <canvas id="irChart" class="graph-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="statusBar" class="status-bar">ì¤€ë¹„ ì™„ë£Œ</div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000/api'; // Flask ë°±ì—”ë“œ ì£¼ì†Œ

        const searchTypeSelect = document.getElementById('searchType');
        const searchQueryInput = document.getElementById('searchQuery');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const resultTableBody = document.querySelector('#resultTable tbody');
        const detailTitle = document.getElementById('detailTitle');
        const detailCurrentValue = document.getElementById('detailCurrentValue');
        const changeInfoDiv = document.getElementById('changeInfo');
        const statusBar = document.getElementById('statusBar');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        let allExchangeRates = [];
        let allInterestRates = [];
        let currentSelectedData = null; // í˜„ì¬ ì„ íƒëœ í•­ëª©ì˜ ì›ë³¸ ë°ì´í„°ë¥¼ ì €ì¥

        // Chart.js ì¸ìŠ¤í„´ìŠ¤
        let fxChartInstance = null;
        let irChartInstance = null;

        function updateStatusBar(message, type = 'info') {
            statusBar.textContent = message;
            statusBar.style.backgroundColor = type === 'error' ? '#f8d7da' : '#e2e3e5';
            statusBar.style.color = type === 'error' ? '#721c24' : '#495057';
        }

        async function fetchDataAndRender() {
            updateStatusBar("ë°ì´í„° ë¡œë”© ì¤‘...", 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/data`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allExchangeRates = data.exchangeRates;
                allInterestRates = data.interestRates;
                populateResults();
                updateStatusBar("ë°ì´í„° ë¡œë“œ ì™„ë£Œ.", 'info');
            } catch (error) {
                console.error("Error fetching initial data:", error);
                updateStatusBar(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function populateResults() {
            resultTableBody.innerHTML = '';
            const searchType = searchTypeSelect.value;
            const searchQuery = searchQueryInput.value.toLowerCase();
            let dataToDisplay = [];

            if (searchType === 'exchange') {
                dataToDisplay = allExchangeRates.filter(item => 
                    item["í†µí™”ìŒ"].toLowerCase().includes(searchQuery)
                );
                dataToDisplay.forEach((item, index) => {
                    const row = resultTableBody.insertRow();
                    row.dataset.type = 'fx';
                    row.dataset.originalIndex = allExchangeRates.indexOf(item); // ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤
                    row.dataset.tickerOrCountry = item.Ticker; // ìƒì„¸ ì •ë³´ ìš”ì²­ì— í•„ìš”
                    row.insertCell(0).textContent = item["í†µí™”ìŒ"];
                    row.insertCell(1).textContent = item["í™˜ìœ¨"] ? item["í™˜ìœ¨"].toFixed(4) : "N/A";
                    row.addEventListener('click', () => handleItemSelection(row, item));
                });
            } else if (searchType === 'interest') {
                dataToDisplay = allInterestRates.filter(item => 
                    item["êµ­ê°€"].toLowerCase().includes(searchQuery)
                );
                dataToDisplay.forEach((item, index) => {
                    const row = resultTableBody.insertRow();
                    row.dataset.type = 'ir';
                    row.dataset.originalIndex = allInterestRates.indexOf(item); // ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤
                    row.dataset.tickerOrCountry = item.êµ­ê°€; // ìƒì„¸ ì •ë³´ ìš”ì²­ì— í•„ìš”
                    row.insertCell(0).textContent = item["êµ­ê°€"];
                    row.insertCell(1).textContent = item["ê¸°ì¤€ ê¸ˆë¦¬"];
                    row.addEventListener('click', () => handleItemSelection(row, item));
                });
            }
        }

        async function handleItemSelection(rowElement, dataItem) {
            // ì´ì „ì— ì„ íƒëœ í–‰ì˜ ìŠ¤íƒ€ì¼ ì œê±°
            const prevSelected = document.querySelector('#resultTable tbody .selected-row');
            if (prevSelected) {
                prevSelected.classList.remove('selected-row');
            }
            // í˜„ì¬ ì„ íƒëœ í–‰ì— ìŠ¤íƒ€ì¼ ì¶”ê°€
            rowElement.classList.add('selected-row');

            currentSelectedData = dataItem;
            updateStatusBar("ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...", 'info');

            detailTitle.textContent = `${dataItem.type === 'fx' ? 'í†µí™”ìŒ' : 'êµ­ê°€'}: ${dataItem.type === 'fx' ? dataItem["í†µí™”ìŒ"] : dataItem["êµ­ê°€"]}`;
            detailCurrentValue.textContent = `í˜„ì¬ ${dataItem.type === 'fx' ? 'í™˜ìœ¨' : 'ê¸°ì¤€ ê¸ˆë¦¬'}: ${dataItem.type === 'fx' ? (dataItem["í™˜ìœ¨"] ? dataItem["í™˜ìœ¨"].toFixed(4) : "N/A") : dataItem["ê¸°ì¤€ ê¸ˆë¦¬"]}`;
            
            // í˜„ì¬ ê°’ì„ ìˆ«ìë¡œ íŒŒì‹±
            let currentRateNumeric;
            if (dataItem.type === 'fx') {
                currentRateNumeric = parseFloat(dataItem["í™˜ìœ¨"]);
            } else { // 'ir'
                const match = dataItem["ê¸°ì¤€ ê¸ˆë¦¬"] ? dataItem["ê¸°ì¤€ ê¸ˆë¦¬"].match(/(\d+\.?\d*)%?/) : null;
                currentRateNumeric = match ? parseFloat(match[1]) : NaN;
            }

            if (isNaN(currentRateNumeric)) {
                changeInfoDiv.innerHTML = "<strong>ê³¼ê±° ë³€í™”ëŸ‰:</strong><br>í˜„ì¬ ê°’ì„ ìˆ«ìë¡œ ë³€í™˜í•  ìˆ˜ ì—†ì–´ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                renderChart('fxChart', [], [], '', '', 'ë°ì´í„° ì—†ìŒ');
                renderChart('irChart', [], [], '', '', 'ë°ì´í„° ì—†ìŒ');
                updateStatusBar("ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ (ê°’ ë³€í™˜ ì˜¤ë¥˜).", 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        itemType: rowElement.dataset.type,
                        itemId: rowElement.dataset.originalIndex,
                        currentRate: currentRateNumeric,
                        tickerOrCountry: rowElement.dataset.tickerOrCountry
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const details = await response.json();

                if (details.error) {
                    throw new Error(details.error);
                }
                
                changeInfoDiv.innerHTML = `<strong>ê³¼ê±° ë³€í™”ëŸ‰:</strong><br>${details.changesText || "ë³€í™”ëŸ‰ ì •ë³´ ì—†ìŒ."}`;
                
                const labels = details.graphData.map(d => d.date);
                const values = details.graphData.map(d => d.value);

                if (rowElement.dataset.type === 'fx') {
                    activateTab('fxGraph');
                    renderChart('fxChart', labels, values, 'í™˜ìœ¨', '#007bff', `${dataItem["í†µí™”ìŒ"]} ì¶”ì´`);
                } else if (rowElement.dataset.type === 'ir') {
                    activateTab('irGraph');
                    renderChart('irChart', labels, values, 'ê¸ˆë¦¬ (%)', '#28a745', `${dataItem["êµ­ê°€"]} ì¶”ì´`);
                }
                updateStatusBar("ìƒì„¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ.", 'info');

            } catch (error) {
                console.error("Error fetching details:", error);
                changeInfoDiv.innerHTML = `<strong>ê³¼ê±° ë³€í™”ëŸ‰:</strong><br>ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                renderChart('fxChart', [], [], '', '', 'ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜');
                renderChart('irChart', [], [], '', '', 'ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜');
                updateStatusBar(`ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function renderChart(canvasId, labels, data, ylabel, color, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: ylabel,
                        data: data,
                        borderColor: color,
                        backgroundColor: `${color}33`, // 20% opacity
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' },
                            color: '#343a40'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: { display: false },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10,
                                font: { size: 10 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: ylabel,
                                font: { size: 12, weight: 'bold' },
                                color: '#495057'
                            },
                            ticks: {
                                font: { size: 10 }
                            },
                            grid: {
                                color: '#e9ecef'
                            }
                        }
                    }
                }
            };
            
            if (canvasId === 'fxChart') {
                if (fxChartInstance) fxChartInstance.destroy();
                fxChartInstance = new Chart(ctx, chartConfig);
            } else if (canvasId === 'irChart') {
                if (irChartInstance) irChartInstance.destroy();
                irChartInstance = new Chart(ctx, chartConfig);
            }
        }

        function activateTab(tabId) {
            tabButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                }
            });
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        searchBtn.addEventListener('click', populateResults);
        searchQueryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') populateResults();
        });
        searchTypeSelect.addEventListener('change', populateResults);
        refreshBtn.addEventListener('click', fetchDataAndRender);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                activateTab(tabId);
                // íƒ­ ì „í™˜ ì‹œ ì°¨íŠ¸ê°€ ë‹¤ì‹œ ê·¸ë ¤ì§€ë„ë¡ (í•„ìš”í•œ ê²½ìš°)
                // if (currentSelectedData) {
                //     handleItemSelection(document.querySelector('.selected-row'), currentSelectedData);
                // }
            });
        });

        // ì´ˆê¸° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', fetchDataAndRender);
    </script>
</body>
</html>
